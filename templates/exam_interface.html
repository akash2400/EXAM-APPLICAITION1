{% extends "base.html" %}

{% block title %}{{ exam.title }} - AI Exam System{% endblock %}

{% block content %}
<div class="exam-container">
    <!-- Exam Header -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-1">{{ exam.title }}</h3>
                    {% if exam.description %}
                    <p class="mb-0 opacity-75">{{ exam.description }}</p>
                    {% endif %}
                </div>
                <div class="text-end">
                    <div class="badge bg-light text-dark fs-6">
                        <i class="fas fa-question-circle me-1"></i>{{ questions|length }} Questions
                    </div>
                    <div class="badge bg-warning text-dark mt-1">
                        AI Evaluation: AI-Powered
                    </div>
                    <div class="badge bg-danger text-white mt-1 fs-6" id="timer">
                        <i class="fas fa-clock me-1"></i><span id="timeDisplay">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Exam Form -->
    <form id="examForm" method="POST" action="{{ url_for('submit_exam') }}">
        <input type="hidden" name="exam_id" value="{{ exam.id }}">
        
        <!-- Progress Bar -->
        <div class="progress mb-4" style="height: 8px;">
            <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
        </div>
        
        <!-- Questions -->
        {% for question in questions %}
        <div class="card shadow-sm mb-4 question-card" data-question="{{ loop.index }}">
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <span class="badge bg-primary me-2">Q{{ loop.index }}</span>
                        Question {{ loop.index }} of {{ questions|length }}
                    </h5>
                    <span class="badge bg-secondary">
                        <i class="fas fa-star me-1"></i>{{ question.max_marks }} Marks
                    </span>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Question:</label>
                    <p class="mb-3">{{ question.question_text }}</p>
                </div>
                
                <div class="mb-3">
                    <label for="answer_{{ question.id }}" class="form-label fw-bold">Your Answer:</label>
                    <textarea class="form-control answer-input" 
                              id="answer_{{ question.id }}" 
                              name="answer_{{ question.id }}" 
                              rows="6" 
                              placeholder="Type your answer here..."
                              data-question="{{ loop.index }}"
                              required></textarea>
                    <div class="form-text">
                        <i class="fas fa-info-circle me-1"></i>
                        Provide a detailed answer. The AI will evaluate your response against the reference answer.
                    </div>
                </div>
                
                <!-- Character Count -->
                <div class="text-end">
                    <small class="text-muted">
                        <span id="charCount_{{ question.id }}">0</span> characters
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}
        
        <!-- Submit Section -->
        <div class="card shadow-sm border-success">
            <div class="card-body text-center">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Important:</strong> Once you submit, you cannot change your answers. 
                    Make sure to review all questions before submitting.
                </div>
                
                <div class="d-flex justify-content-center gap-3">
                    <a href="{{ url_for('student_dashboard') }}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                    <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                        <i class="fas fa-paper-plane me-2"></i>Submit Exam
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Submission Modal -->
<div class="modal fade" id="submissionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Exam Submitted Successfully!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-trophy fa-3x text-success mb-3"></i>
                <h6>Your exam has been submitted and evaluated by AI!</h6>
                <p class="text-muted">You will be redirected to view your results.</p>
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let answeredQuestions = 0;
const totalQuestions = {{ questions|length }};

// Character count for each answer
document.querySelectorAll('.answer-input').forEach(textarea => {
    const questionId = textarea.id;
    const charCountId = 'charCount_' + questionId.split('_')[1];
    
    textarea.addEventListener('input', function() {
        const charCount = this.value.length;
        document.getElementById(charCountId).textContent = charCount;
        
        // Update progress
        if (this.value.trim().length > 0) {
            if (!this.hasAttribute('data-answered')) {
                this.setAttribute('data-answered', 'true');
                answeredQuestions++;
            }
        } else {
            if (this.hasAttribute('data-answered')) {
                this.removeAttribute('data-answered');
                answeredQuestions--;
            }
        }
        
        updateProgress();
    });
});

function updateProgress() {
    const progress = (answeredQuestions / totalQuestions) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    
    if (progress === 100) {
        document.getElementById('progressBar').classList.add('bg-success');
    } else {
        document.getElementById('progressBar').classList.remove('bg-success');
    }
}

// Form submission
document.getElementById('examForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Check if all questions are answered
    const unansweredQuestions = document.querySelectorAll('.answer-input:not([data-answered])');
    if (unansweredQuestions.length > 0) {
        if (!confirm('You have unanswered questions. Are you sure you want to submit?')) {
            return;
        }
    }
    
    // Disable submit button
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
    
    // Submit form via AJAX
    const formData = new FormData(this);
    
    fetch('{{ url_for("submit_exam") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Submit Exam';
        } else {
            // Show success modal
            const modal = new bootstrap.Modal(document.getElementById('submissionModal'));
            modal.show();
            
            // Redirect after delay
            setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while submitting the exam. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Submit Exam';
    });
});

// Initialize progress
updateProgress();

// Timer functionality
let timeRemaining = {{ (time_remaining or 60) * 60 }}; // Convert minutes to seconds, default to 60 minutes
let timerInterval;
let warningShown = false;

function updateTimer() {
    const hours = Math.floor(timeRemaining / 3600);
    const minutes = Math.floor((timeRemaining % 3600) / 60);
    const seconds = timeRemaining % 60;
    
    let timeString = '';
    if (hours > 0) {
        timeString = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    } else {
        timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    document.getElementById('timeDisplay').textContent = timeString;
    
    // Change color based on remaining time
    const timerElement = document.getElementById('timer');
    if (timeRemaining <= 300) { // 5 minutes or less
        timerElement.className = 'badge bg-danger text-white mt-1 fs-6';
        // Show warning when 5 minutes left
        if (timeRemaining === 300 && !warningShown) {
            alert('⚠️ WARNING: Only 5 minutes remaining! Please submit your exam soon.');
            warningShown = true;
        }
    } else if (timeRemaining <= 900) { // 15 minutes or less
        timerElement.className = 'badge bg-warning text-dark mt-1 fs-6';
    } else {
        timerElement.className = 'badge bg-success text-white mt-1 fs-6';
    }
    
    if (timeRemaining <= 0) {
        clearInterval(timerInterval);
        
        // Show auto-submission notification
        showAutoSubmissionNotification();
        
        // Auto-submit the exam using the same AJAX method as manual submission
        autoSubmitExam();
        return;
    }
    
    timeRemaining--;
}

// Auto-submission functions
function showAutoSubmissionNotification() {
    // Create a prominent notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-warning alert-dismissible fade show position-fixed';
    notification.style.cssText = `
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        min-width: 400px;
        text-align: center;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    `;
    
    notification.innerHTML = `
        <h5><i class="fas fa-clock me-2"></i>Time's Up!</h5>
        <p class="mb-0">Your exam time has expired. Your answers are being submitted automatically...</p>
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

function autoSubmitExam() {
    // Disable all form inputs to prevent further changes
    const formInputs = document.querySelectorAll('input, textarea, button');
    formInputs.forEach(input => {
        input.disabled = true;
    });
    
    // Update submit button to show auto-submission
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-clock me-2"></i>Auto-Submitting...';
        submitBtn.classList.remove('btn-success');
        submitBtn.classList.add('btn-warning');
    }
    
    // Submit form via AJAX (same as manual submission)
    const form = document.getElementById('examForm');
    const formData = new FormData(form);
    
    fetch('{{ url_for("submit_exam") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            // Show error but still redirect to dashboard
            console.error('Auto-submission error:', data.error);
            showAutoSubmissionError(data.error);
        } else {
            // Show success modal
            const modal = new bootstrap.Modal(document.getElementById('submissionModal'));
            modal.show();
            
            // Update modal content for auto-submission
            const modalTitle = document.querySelector('#submissionModal .modal-title');
            const modalBody = document.querySelector('#submissionModal .modal-body h6');
            if (modalTitle) {
                modalTitle.innerHTML = '<i class="fas fa-clock me-2"></i>Exam Auto-Submitted!';
            }
            if (modalBody) {
                modalBody.textContent = 'Your exam was automatically submitted due to time expiration.';
            }
            
            // Redirect after delay
            setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 3000);
        }
    })
    .catch(error => {
        console.error('Auto-submission error:', error);
        showAutoSubmissionError('An error occurred during auto-submission. Please contact your instructor.');
        
        // Still redirect to dashboard after error
        setTimeout(() => {
            window.location.href = '{{ url_for("student_dashboard") }}';
        }, 5000);
    });
}

function showAutoSubmissionError(errorMessage) {
    const errorNotification = document.createElement('div');
    errorNotification.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    errorNotification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 10000;
        min-width: 300px;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    `;
    
    errorNotification.innerHTML = `
        <h6><i class="fas fa-exclamation-triangle me-2"></i>Auto-Submission Error</h6>
        <p class="mb-0">${errorMessage}</p>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(errorNotification);
    
    // Remove after 10 seconds
    setTimeout(() => {
        if (errorNotification.parentNode) {
            errorNotification.remove();
        }
    }, 10000);
}

// Timer synchronization with server
function syncTimerWithServer() {
    fetch('{{ url_for("get_exam_time_remaining", exam_id=exam.id) }}')
        .then(response => response.json())
        .then(data => {
            if (data.time_remaining !== undefined) {
                const serverTimeRemaining = data.time_remaining * 60; // Convert minutes to seconds
                const timeDifference = Math.abs(timeRemaining - serverTimeRemaining);
                
                // If there's a significant difference (more than 30 seconds), sync with server
                if (timeDifference > 30) {
                    console.log(`Syncing timer: Client=${timeRemaining}s, Server=${serverTimeRemaining}s`);
                    timeRemaining = serverTimeRemaining;
                }
            }
        })
        .catch(error => {
            console.log('Timer sync failed:', error);
        });
}

// Start the timer
timerInterval = setInterval(updateTimer, 1000);
updateTimer(); // Initial call

// Sync timer with server every 30 seconds
setInterval(syncTimerWithServer, 30000);
</script>
{% endblock %}
